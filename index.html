<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tikir Takar Pro</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            /* Palette */
            --bg-dark: #0f172a;
            --bg-light: #1e293b;
            --primary: #6366f1;
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --secondary: #3b82f6;
            --accent: #f43f5e;
            --gold: #fbbf24;
            --gold-gradient: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            /* Glassmorphism */
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --blur: blur(12px);

            /* Spacing & Radius */
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --safe-area-top: env(safe-area-inset-top, 20px);
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            color: var(--text-main);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }

        /* --- Utils --- */
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .flex-col { display: flex; flex-direction: column; }
        .w-full { width: 100%; }

        /* --- App Container --- */
        #app-container {
            width: 100%;
            max-width: 480px;
            height: 100%;
            position: relative;
            background: rgba(15, 23, 42, 0.5);
            display: flex;
            flex-direction: column;
        }

        /* --- Screens --- */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: calc(var(--safe-area-top) + 20px) 20px calc(var(--safe-area-bottom) + 80px); /* Bottom padding for ads */
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .screen.active {
            opacity: 1;
            pointer-events: all;
            transform: scale(1);
            z-index: 20;
        }

        /* --- UI Components --- */
        
        /* Headers & Title */
        .game-title {
            font-size: 3.5rem;
            font-weight: 800;
            text-align: center;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2rem;
            letter-spacing: -2px;
            filter: drop-shadow(0 4px 10px rgba(99, 102, 241, 0.3));
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-main);
        }

        /* Cards / Panels */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--glass-shadow);
            margin-bottom: 20px;
        }

        /* Buttons */
        .btn {
            border: none;
            outline: none;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .btn:active { transform: scale(0.96); }
        .btn:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        
        .btn-gold {
            background: var(--gold-gradient);
            color: #0f172a;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .btn-danger {
            background: rgba(244, 63, 94, 0.2);
            color: var(--accent);
            border: 1px solid rgba(244, 63, 94, 0.4);
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 50%;
            font-size: 1.2rem;
        }

        /* Modes Grid */
        .mode-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            width: 100%;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-card:hover {
            background: rgba(255, 255, 255, 0.07);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        .mode-icon { font-size: 1.5rem; }
        .mode-info h3 { font-size: 1.1rem; margin-bottom: 4px; }
        .mode-info p { font-size: 0.85rem; color: var(--text-muted); }

        /* Top Bar */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            width: 100%;
        }

        .coin-pill {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(251, 191, 36, 0.3);
            padding: 8px 16px;
            border-radius: 100px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            color: var(--gold);
            font-size: 0.95rem;
        }

        .avatar-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a855f7, #ec4899);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
        }

        /* Inputs */
        .input-wrapper {
            position: relative;
            margin-bottom: 15px;
            width: 100%;
        }
        input {
            width: 100%;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 16px;
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            text-align: center;
            transition: 0.3s;
        }
        input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        /* Game Board */
        .board-container {
            width: 100%;
            max-width: 360px;
            margin: 20px auto;
            position: relative;
        }
        .game-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 12px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .cell {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            font-weight: 800;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .cell:active { transform: scale(0.92); }
        .cell.x { color: var(--primary); text-shadow: 0 0 25px rgba(99, 102, 241, 0.5); }
        .cell.o { color: var(--accent); text-shadow: 0 0 25px rgba(244, 63, 94, 0.5); }

        .player-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            background: rgba(0,0,0,0.2);
            padding: 6px;
            border-radius: var(--radius-md);
        }
        .p-tag {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            color: var(--text-muted);
            transition: 0.3s;
            flex: 1;
            text-align: center;
        }
        .p-tag.active {
            background: rgba(255,255,255,0.1);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Spin Wheel */
        .wheel-wrap {
            position: relative;
            width: 260px;
            height: 260px;
            margin: 0 auto 30px;
        }
        .wheel-outer {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 8px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
            overflow: hidden;
            position: relative;
            background: #1e293b;
        }
        #spin-wheel {
            width: 100%;
            height: 100%;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            background: conic-gradient(
                #f43f5e 0deg 45deg, 
                #3b82f6 45deg 90deg, 
                #10b981 90deg 135deg, 
                #fbbf24 135deg 180deg, 
                #8b5cf6 180deg 225deg, 
                #ec4899 225deg 270deg, 
                #6366f1 270deg 315deg, 
                #14b8a6 315deg 360deg
            );
        }
        .wheel-pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 35px solid white;
            z-index: 5;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3));
        }
        .wheel-number {
            position: absolute;
            width: 50%;
            top: 50%;
            left: 50%;
            transform-origin: 0% 50%;
            text-align: right;
            padding-right: 30px;
            color: white;
            font-weight: 800;
            font-size: 1.1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
            pointer-events: none;
            margin-top: -10px; /* Center vertically */
        }

        /* Popups / Overlays */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            padding: 20px;
        }
        .overlay:not(.hidden) {
            opacity: 1;
            pointer-events: all;
        }
        .popup-card {
            background: var(--bg-light);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 30px 24px;
            width: 100%;
            max-width: 360px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.9);
            transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: center;
            position: relative;
        }
        .overlay:not(.hidden) .popup-card {
            transform: scale(1);
        }
        .popup-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        /* Toast */
        #toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 200;
            opacity: 0;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
            width: max-content;
        }
        #toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Ads Container */
        .ads-wrapper {
            width: 100%;
            margin-top: auto;
            background: rgba(0,0,0,0.2);
            border-radius: var(--radius-md);
            overflow: hidden;
            display: flex;
            justify-content: center;
            padding: 10px 0;
            min-height: 270px;
        }
        .ad-scroll {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            width: 100%;
            align-items: center;
        }

        /* Loader */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Sync Overlay Text */
        #sync-timer { font-size: 5rem; font-weight: 800; color: var(--gold); line-height: 1; margin-bottom: 10px; }
        .big-code { font-size: 3.5rem; letter-spacing: 4px; font-weight: 800; color: var(--primary); margin: 15px 0; }
    </style>
</head>
<body>

    <div id="app-container">
        
        <!-- HOME SCREEN -->
        <div id="screen-home" class="screen active">
            <div class="top-nav">
                <div class="avatar-circle" onclick="openProfile()">
                    üë§
                </div>
                <div class="coin-pill">
                    <span>ü™ô</span> <span id="global-coins">0</span>
                </div>
                <button class="btn btn-secondary btn-icon" onclick="openSettings()">‚öôÔ∏è</button>
            </div>

            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                <h1 class="game-title">TIKIR<br>TAKAR</h1>

                <div class="mode-grid">
                    <div class="mode-card" onclick="startLocalGame('pvc')">
                        <div class="mode-icon">ü§ñ</div>
                        <div class="mode-info">
                            <h3>Single Player</h3>
                            <p>Challenge the AI</p>
                        </div>
                    </div>
                    
                    <div class="mode-card" onclick="startLocalGame('pvp')">
                        <div class="mode-icon">üë•</div>
                        <div class="mode-info">
                            <h3>Local 1v1</h3>
                            <p>Play on same device</p>
                        </div>
                    </div>

                    <div class="mode-card" style="background: rgba(99, 102, 241, 0.15); border-color: var(--primary);" onclick="showScreen('screen-lobby')">
                        <div class="mode-icon">‚öîÔ∏è</div>
                        <div class="mode-info">
                            <h3>Online Battle</h3>
                            <p>Play with friends globally</p>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
                    <button class="btn btn-gold" style="margin:0; font-size: 0.9rem;" onclick="openAdsMenu()">üì∫ Free Coins</button>
                    <button class="btn btn-gold" style="margin:0; font-size: 0.9rem;" onclick="openSpinMenu()">üé° Spin Win</button>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="shareGame()">üì§ Share</button>
                <button class="btn btn-secondary" onclick="rateGame()">‚≠ê Rate</button>
            </div>
            
            <!-- Banner Ad Home -->
            <div class="ads-wrapper" style="min-height: 60px; height: 60px; margin-top: 10px;">
                 <p style="font-size: 0.7rem; color: var(--text-muted); align-self: center;">Sponsored Ad Space</p>
            </div>
        </div>

        <!-- LOBBY SCREEN -->
        <div id="screen-lobby" class="screen">
            <div class="top-nav">
                <button class="btn btn-secondary btn-icon" onclick="showScreen('screen-home')">‚Üê</button>
                <h2 class="section-title" style="margin:0">Multiplayer</h2>
                <div style="width: 44px;"></div>
            </div>

            <div class="glass-panel" style="margin-top: auto; margin-bottom: auto;">
                <h3 style="text-align: center; margin-bottom: 20px;">Create or Join</h3>
                
                <button class="btn btn-primary" onclick="checkFeeAndCreate()">
                    <span>Create Room</span>
                    <span style="font-size: 0.8rem; background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px;">100 ü™ô</span>
                </button>

                <div style="display: flex; align-items: center; gap: 10px; margin: 20px 0;">
                    <div style="height: 1px; background: rgba(255,255,255,0.1); flex: 1;"></div>
                    <span style="color: var(--text-muted); font-size: 0.9rem;">OR</span>
                    <div style="height: 1px; background: rgba(255,255,255,0.1); flex: 1;"></div>
                </div>

                <div class="input-wrapper">
                    <input type="number" id="join-code" placeholder="Enter 6-digit Code">
                </div>
                <button class="btn btn-secondary" onclick="joinRoom()">Join Room</button>
            </div>

             <div class="ads-wrapper">
                <script>atOptions={'key':'c3109d9901d494129cfa270600bf411e','format':'iframe','height':250,'width':300,'params':{}};</script><script src="https://www.highperformanceformat.com/c3109d9901d494129cfa270600bf411e/invoke.js"></script>
            </div>
        </div>

        <!-- WAITING SCREEN -->
        <div id="screen-waiting" class="screen">
            <div class="flex-center flex-col" style="height: 100%;">
                <p style="color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">Room Code</p>
                <div id="disp-code" class="big-code"></div>
                
                <div class="spinner"></div>
                <p style="margin-bottom: 30px;">Waiting for opponent...</p>

                <button class="btn btn-danger" style="width: auto; padding-left: 30px; padding-right: 30px;" onclick="confirmExit()">Cancel</button>
            </div>
             <div class="ads-wrapper">
                <script>atOptions={'key':'c3109d9901d494129cfa270600bf411e','format':'iframe','height':250,'width':300,'params':{}};</script><script src="https://www.highperformanceformat.com/c3109d9901d494129cfa270600bf411e/invoke.js"></script>
            </div>
        </div>

        <!-- ONLINE GAME SCREEN -->
        <div id="screen-game" class="screen">
            <!-- Sync Overlay -->
            <div id="overlay-sync" class="overlay hidden" style="background: rgba(15,23,42,0.95); flex-direction: column; z-index: 50;">
                 <div id="sync-timer">5</div>
                 <p id="sync-msg" style="font-size: 1.2rem; color: var(--text-main);">Prepare for Battle!</p>
                 
                 <div id="paused-ui" class="hidden" style="text-align: center; margin-top: 20px;">
                    <p style="color: var(--gold); margin-bottom: 20px;">Room: <span id="paused-room-code"></span></p>
                    <button class="btn btn-danger" onclick="confirmExit()">Exit Game</button>
                 </div>
            </div>

            <div class="top-nav">
                <button class="btn btn-secondary btn-icon" style="font-size: 0.9rem; width: auto; padding: 0 16px; border-radius: 12px;" onclick="leaveGame()">Quit</button>
                <div style="font-size: 0.8rem; opacity: 0.6;" id="game-room-id"></div>
            </div>

            <div class="player-bar">
                <div id="p1-badge" class="p-tag">Player X</div>
                <div id="p2-badge" class="p-tag">Player O</div>
            </div>

            <div id="status-text" style="text-align: center; margin-bottom: 15px; color: var(--text-muted); font-weight: 600;">Game Starting...</div>

            <div class="board-container">
                <div class="game-grid">
                    <div class="cell" onclick="move(0)" id="c0"></div>
                    <div class="cell" onclick="move(1)" id="c1"></div>
                    <div class="cell" onclick="move(2)" id="c2"></div>
                    <div class="cell" onclick="move(3)" id="c3"></div>
                    <div class="cell" onclick="move(4)" id="c4"></div>
                    <div class="cell" onclick="move(5)" id="c5"></div>
                    <div class="cell" onclick="move(6)" id="c6"></div>
                    <div class="cell" onclick="move(7)" id="c7"></div>
                    <div class="cell" onclick="move(8)" id="c8"></div>
                </div>
            </div>

            <div class="ads-wrapper">
                <script>atOptions={'key':'c3109d9901d494129cfa270600bf411e','format':'iframe','height':250,'width':300,'params':{}};</script><script src="https://www.highperformanceformat.com/c3109d9901d494129cfa270600bf411e/invoke.js"></script>
            </div>
        </div>

        <!-- LOCAL GAME SCREEN -->
        <div id="screen-game-local" class="screen">
            <div class="top-nav">
                <button class="btn btn-secondary btn-icon" style="font-size: 0.9rem; width: auto; padding: 0 16px; border-radius: 12px;" onclick="quitLocalGame()">Exit</button>
                <div id="local-mode-badge" style="font-size: 0.8rem; font-weight: 700; color: var(--gold);">OFFLINE</div>
            </div>

            <div class="player-bar">
                <div id="lp1-badge" class="p-tag active">X (You)</div>
                <div id="lp2-badge" class="p-tag">O (CPU)</div>
            </div>

            <div id="local-status" style="text-align: center; margin-bottom: 15px; color: var(--text-muted); font-weight: 600;">Your Turn</div>

            <div class="board-container">
                <div class="game-grid">
                    <div class="cell" onclick="localMove(0)" id="lc0"></div>
                    <div class="cell" onclick="localMove(1)" id="lc1"></div>
                    <div class="cell" onclick="localMove(2)" id="lc2"></div>
                    <div class="cell" onclick="localMove(3)" id="lc3"></div>
                    <div class="cell" onclick="localMove(4)" id="lc4"></div>
                    <div class="cell" onclick="localMove(5)" id="lc5"></div>
                    <div class="cell" onclick="localMove(6)" id="lc6"></div>
                    <div class="cell" onclick="localMove(7)" id="lc7"></div>
                    <div class="cell" onclick="localMove(8)" id="lc8"></div>
                </div>
            </div>
            
            <div class="ads-wrapper">
                <script>atOptions={'key':'c3109d9901d494129cfa270600bf411e','format':'iframe','height':250,'width':300,'params':{}};</script><script src="https://www.highperformanceformat.com/c3109d9901d494129cfa270600bf411e/invoke.js"></script>
            </div>
        </div>

        <!-- POPUPS -->

        <!-- Name Setup -->
        <div id="popup-name-setup" class="overlay hidden" style="z-index: 300;">
            <div class="popup-card">
                <h2>Welcome!</h2>
                <p style="color: var(--text-muted); margin: 10px 0 20px;">Enter your name to start playing.</p>
                <div class="input-wrapper">
                    <input type="text" id="input-setup-name" placeholder="Your Name">
                </div>
                <button class="btn btn-primary" onclick="submitNameSetup()">Let's Play</button>
            </div>
        </div>

        <!-- Profile -->
        <div id="popup-profile" class="overlay hidden">
            <div class="popup-card">
                <button class="popup-close" onclick="closePopup('popup-profile')">‚úï</button>
                <div class="avatar-circle" style="width: 80px; height: 80px; margin: 0 auto 15px; font-size: 2rem;">üë§</div>
                <h2 style="margin-bottom: 20px;">Your Profile</h2>
                
                <div class="input-wrapper">
                    <input type="text" id="profile-name" onchange="saveProfile()" placeholder="Guest">
                </div>

                <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between;">
                    <span>Balance</span>
                    <span style="color: var(--gold); font-weight: 700;"><span id="profile-coins">0</span> ü™ô</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <div style="flex:1; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px;">
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Played</div>
                        <div id="profile-played" style="font-size: 1.2rem; font-weight: 700;">0</div>
                    </div>
                    <div style="flex:1; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px;">
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Won</div>
                        <div id="profile-won" style="font-size: 1.2rem; font-weight: 700; color: var(--primary);">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div id="popup-settings" class="overlay hidden">
            <div class="popup-card">
                <button class="popup-close" onclick="closePopup('popup-settings')">‚úï</button>
                <h2>Settings</h2>
                <br>
                <button class="btn btn-secondary" id="btn-sound" onclick="toggleSetting('sound')">Sound: ON</button>
                <button class="btn btn-secondary" id="btn-vib" onclick="toggleSetting('vib')">Vibration: ON</button>
            </div>
        </div>

        <!-- Ads Loader/Display -->
        <div id="popup-ads-loading" class="overlay hidden" style="z-index: 210;">
            <div class="popup-card">
                <div class="spinner"></div>
                <p>Loading Sponsors...</p>
            </div>
        </div>

        <div id="popup-ads" class="overlay hidden" style="z-index: 200;">
            <div class="popup-card" style="height: 80vh; max-height: 80vh; display: flex; flex-direction: column;">
                <h3>Sponsors</h3>
                <p id="ads-timer" style="color: var(--gold); font-weight: 700; margin: 10px 0;">Wait 30s</p>
                
                <div class="ad-scroll">
                    <!-- Ads injected here -->
                    <div class="ad-slot"><script>atOptions={'key':'c3109d9901d494129cfa270600bf411e','format':'iframe','height':250,'width':300,'params':{}};</script><script src="https://www.highperformanceformat.com/c3109d9901d494129cfa270600bf411e/invoke.js"></script></div>
                    <div class="ad-slot"><script>atOptions={'key':'c3109d9901d494129cfa270600bf411e','format':'iframe','height':250,'width':300,'params':{}};</script><script src="https://www.highperformanceformat.com/c3109d9901d494129cfa270600bf411e/invoke.js"></script></div>
                    <div class="ad-slot"><script>atOptions={'key':'c3109d9901d494129cfa270600bf411e','format':'iframe','height':250,'width':300,'params':{}};</script><script src="https://www.highperformanceformat.com/c3109d9901d494129cfa270600bf411e/invoke.js"></script></div>
                </div>

                <button class="btn btn-gold" id="btn-skip-ads" disabled onclick="skipAds()" style="margin-top: 15px;">Claim Reward</button>
            </div>
        </div>

        <!-- Spin Wheel -->
        <div id="popup-spin" class="overlay hidden">
            <div class="popup-card">
                <button class="popup-close" onclick="closePopup('popup-spin')">‚úï</button>
                <h2>Lucky Spin</h2>
                <br>
                <div class="wheel-wrap">
                    <div class="wheel-pointer"></div>
                    <div class="wheel-outer">
                        <div id="spin-wheel">
                            <!-- JS Generates Numbers -->
                        </div>
                    </div>
                </div>
                
                <div id="spin-controls">
                    <!-- Buttons injected by JS -->
                </div>
                <p id="spin-msg" style="color: var(--text-muted); font-size: 0.9rem; margin-top: 15px;">Spin to win coins!</p>
            </div>
        </div>

        <!-- Result Online -->
        <div id="modal-result" class="overlay hidden" style="z-index: 150;">
            <div class="popup-card">
                <h2 id="res-title" style="font-size: 2.5rem; margin-bottom: 5px;">VICTORY</h2>
                <p id="res-msg" style="color: var(--text-muted); margin-bottom: 20px;">You played well!</p>
                <button id="btn-restart" class="btn btn-primary hidden" onclick="restartGame()">Play Again</button>
                <button class="btn btn-secondary" onclick="leaveGame()">Exit to Menu</button>
            </div>
        </div>

        <!-- Result Local -->
        <div id="modal-local-result" class="overlay hidden" style="z-index: 150;">
            <div class="popup-card">
                <h2 id="lres-title" style="font-size: 2.5rem; margin-bottom: 20px;">Winner!</h2>
                <button class="btn btn-primary" onclick="startLocalGame(currentLocalMode)">Rematch</button>
                <button class="btn btn-secondary" onclick="quitLocalGame()">Main Menu</button>
            </div>
        </div>

        <!-- Exit Confirm -->
        <div id="popup-exit-confirm" class="overlay hidden" style="z-index: 400;">
            <div class="popup-card">
                <h3>Leave Game?</h3>
                <p style="margin: 15px 0; color: var(--text-muted);">You will lose your progress.</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="closePopup('popup-exit-confirm')">Stay</button>
                    <button class="btn btn-danger" onclick="executeExit()">Leave</button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast">Message</div>

        <!-- Rate Popup -->
        <div id="popup-rate" class="overlay hidden">
            <div class="popup-card">
                <button class="popup-close" onclick="closePopup('popup-rate')">‚úï</button>
                <h2>Rate Us</h2>
                <div style="font-size: 2rem; margin: 20px 0;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                <p>Coming to Play Store soon!</p>
            </div>
        </div>

    </div>

    <script>
        // ===== GAME CONFIG =====
        const GAME_CONFIG = {
            AD_REWARD_COINS: 100,
            CREATE_ROOM_COST: 100,
            SPIN_COST_COINS: 200,
            SPIN_COOLDOWN_MINUTES: 30
        };
        const SPIN_VALUES = [100, 500, 300, 100, 900, 200, 100, 200];

        // ===== FIREBASE INIT =====
        const firebaseConfig = {
            apiKey: "AIzaSyARK-7hEMSeJIfptErVQxYS2-R5O3beyko",
            authDomain: "myspot-3a5d7.firebaseapp.com",
            databaseURL: "https://myspot-3a5d7-default-rtdb.firebaseio.com",
            projectId: "myspot-3a5d7",
            storageBucket: "myspot-3a5d7.firebasestorage.app",
            messagingSenderId: "897963670567",
            appId: "1:897963670567:web:bab24376732b0b68252202"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ===== STATE =====
        let userCoins = parseInt(localStorage.getItem('coins') || '500');
        let playerName = localStorage.getItem('pName'); 
        let gamesPlayed = parseInt(localStorage.getItem('gPlayed') || '0');
        let gamesWon = parseInt(localStorage.getItem('gWon') || '0');
        let settings = JSON.parse(localStorage.getItem('settings') || '{"sound":true,"vib":true}');

        // ===== HELPERS =====
        const $ = id => document.getElementById(id);
        const show = id => $(id).classList.remove('hidden');
        const hide = id => $(id).classList.add('hidden');
        const showScreen = id => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            $(id).classList.add('active');
        };
        const toast = msg => {
            const t = $('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        function updateCoins(amount) {
            userCoins += amount;
            localStorage.setItem('coins', userCoins);
            $('global-coins').innerText = userCoins;
            if($('profile-coins')) $('profile-coins').innerText = userCoins;
        }

        function updateStats(won) {
            gamesPlayed++;
            if(won) gamesWon++;
            localStorage.setItem('gPlayed', gamesPlayed);
            localStorage.setItem('gWon', gamesWon);
        }

        // ===== INIT =====
        $('global-coins').innerText = userCoins;
        if(playerName) $('profile-name').value = playerName;

        window.addEventListener('load', () => {
            if (!playerName || playerName.trim() === '') {
                show('popup-name-setup');
            }
            renderWheel(); 
        });

        // ===== NAME & PROFILE =====
        function submitNameSetup() {
            const nameInput = $('input-setup-name').value.trim();
            if (nameInput.length < 2) {
                toast("Name too short!");
                return;
            }
            playerName = nameInput;
            localStorage.setItem('pName', playerName);
            $('profile-name').value = playerName;
            hide('popup-name-setup');
        }

        function openProfile() {
            $('profile-name').value = playerName || '';
            $('profile-coins').innerText = userCoins;
            $('profile-played').innerText = gamesPlayed;
            $('profile-won').innerText = gamesWon;
            show('popup-profile');
        }

        function saveProfile() {
            const val = $('profile-name').value.trim();
            if(val.length >= 2) {
                playerName = val;
                localStorage.setItem('pName', playerName);
            }
        }

        function openSettings() {
            $('btn-sound').innerText = `Sound: ${settings.sound ? 'ON' : 'OFF'}`;
            $('btn-vib').innerText = `Vibration: ${settings.vib ? 'ON' : 'OFF'}`;
            show('popup-settings');
        }

        function toggleSetting(key) {
            settings[key] = !settings[key];
            localStorage.setItem('settings', JSON.stringify(settings));
            openSettings();
        }

        function closePopup(id) { hide(id); }

        function shareGame() {
            if(navigator.share) {
                navigator.share({
                    title: 'Tikir Takar Pro',
                    text: 'Beat me at Tic Tac Toe!',
                    url: 'https://happybirthday2uuuuu.blogspot.com/?m=1'
                });
            } else {
                toast("Link copied to clipboard!");
            }
        }
        function rateGame() { show('popup-rate'); }

        // ===== ADS SYSTEM =====
        let adInterval = null;
        let pendingAdCallback = null; 

        function openAdsMenu(callback = null) {
            pendingAdCallback = callback;
            show('popup-ads-loading');
            setTimeout(() => {
                hide('popup-ads-loading');
                show('popup-ads');
                startAdTimer();
            }, 2000);
        }

        function startAdTimer() {
            const btn = $('btn-skip-ads');
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner" style="width:16px;height:16px;border-width:2px;margin:0"></span> Wait...`;
            
            let duration = Math.floor(Math.random() * (33 - 23 + 1)) + 23;
            $('ads-timer').innerText = `Wait ${duration}s`;

            if(adInterval) clearInterval(adInterval);
            adInterval = setInterval(() => {
                duration--;
                $('ads-timer').innerText = `Wait ${duration}s`;
                if(duration <= 0) {
                    clearInterval(adInterval);
                    btn.disabled = false;
                    btn.innerText = "Claim Reward";
                    $('ads-timer').innerText = "Reward Ready!";
                }
            }, 1000);
        }

        function skipAds() {
            hide('popup-ads');
            if(pendingAdCallback) {
                pendingAdCallback();
                pendingAdCallback = null;
            } else {
                updateCoins(GAME_CONFIG.AD_REWARD_COINS);
                toast(`+${GAME_CONFIG.AD_REWARD_COINS} Coins!`);
            }
        }

        // ===== SPINNER LOGIC =====
        function renderWheel() {
            const wheel = $('spin-wheel');
            wheel.innerHTML = ''; // Clear prev
            const segAngle = 360 / SPIN_VALUES.length;
            
            SPIN_VALUES.forEach((val, i) => {
                const el = document.createElement('div');
                el.className = 'wheel-number';
                const rotation = (i * segAngle) + (segAngle / 2); 
                el.style.transform = `rotate(${rotation}deg)`;
                el.innerText = val;
                wheel.appendChild(el);
            });
        }

        function openSpinMenu() {
            show('popup-spin');
            checkSpinState();
        }

        function checkSpinState() {
            const lastSpin = parseInt(localStorage.getItem('lastSpin') || '0');
            const now = Date.now();
            const diff = now - lastSpin;
            const cooldownMs = GAME_CONFIG.SPIN_COOLDOWN_MINUTES * 60 * 1000;

            const controls = $('spin-controls');
            
            if (diff < cooldownMs) {
                const minsLeft = Math.ceil((cooldownMs - diff) / 60000);
                $('spin-msg').innerText = `Cooldown: ${minsLeft}m. Skip wait?`;
                
                controls.innerHTML = `
                    <button class="btn btn-gold" onclick="openAdsMenu(doSpinLogic)">üé• Watch Ad</button>
                    <button class="btn btn-secondary" onclick="payToSpin()">üí∞ Pay ${GAME_CONFIG.SPIN_COST_COINS}</button>
                `;
            } else {
                $('spin-msg').innerText = "Free Spin Available!";
                controls.innerHTML = `<button class="btn btn-primary" onclick="doSpinLogic()">Spin Free</button>`;
            }
        }

        function payToSpin() {
            if(userCoins >= GAME_CONFIG.SPIN_COST_COINS) {
                updateCoins(-GAME_CONFIG.SPIN_COST_COINS);
                doSpinLogic();
            } else {
                toast("Not enough coins!");
            }
        }

        function doSpinLogic() {
            localStorage.setItem('lastSpin', Date.now());
            
            const wheel = $('spin-wheel');
            const segmentDeg = 360 / SPIN_VALUES.length;
            const targetIndex = Math.floor(Math.random() * SPIN_VALUES.length);
            const spins = 5; 
            // Add a small offset to ensure it lands nicely in the center of segment
            const targetDeg = (spins * 360) + ((SPIN_VALUES.length - 1 - targetIndex) * segmentDeg); 
            
            $('spin-controls').innerHTML = "<button class='btn' disabled>Spinning...</button>";
            
            wheel.style.transform = `rotate(${targetDeg}deg)`;

            setTimeout(() => {
                const actualWin = SPIN_VALUES[targetIndex]; 
                
                updateCoins(actualWin);
                toast(`You won ${actualWin} Coins!`);
                $('spin-msg').innerText = `Won ${actualWin}!`;
                checkSpinState(); 
                
                // Reset rotation silently for next time
                setTimeout(() => {
                    wheel.style.transition = 'none';
                    wheel.style.transform = 'rotate(0deg)';
                    setTimeout(() => wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)', 50);
                }, 1000);
            }, 4000);
        }

        // ===== LOCAL GAME LOGIC =====
        let localBoard = [];
        let localTurn = 'X';
        let currentLocalMode = 'pvc'; 
        let isCpuThinking = false;

        function startLocalGame(mode) {
            currentLocalMode = mode;
            localBoard = Array(9).fill("");
            localTurn = 'X';
            isCpuThinking = false;
            
            $('local-mode-badge').innerText = mode === 'pvc' ? "VS COMPUTER" : "2 PLAYER";
            $('lp2-badge').innerText = mode === 'pvc' ? "O (CPU)" : "Player O";
            
            renderLocalBoard();
            hide('modal-local-result');
            showScreen('screen-game-local');
        }

        function localMove(idx) {
            if (localBoard[idx] !== "" || isCpuThinking) return;
            if (currentLocalMode === 'pvc' && localTurn === 'O') return;

            executeLocalMove(idx);

            if (currentLocalMode === 'pvc' && !checkWinLocal(localBoard) && localBoard.includes("")) {
                isCpuThinking = true;
                $('local-status').innerText = "Computer thinking...";
                setTimeout(() => {
                    cpuPlay();
                    isCpuThinking = false;
                }, 600);
            }
        }

        function executeLocalMove(idx) {
            localBoard[idx] = localTurn;
            renderLocalBoard();

            const winner = checkWinLocal(localBoard);
            if (winner) {
                updateStats(winner === 'X'); 
                showLocalResult(winner);
                return;
            }

            localTurn = localTurn === 'X' ? 'O' : 'X';
            updateLocalUI();
        }

        function cpuPlay() {
            let available = [];
            localBoard.forEach((val, i) => { if(val === "") available.push(i); });
            if (available.length > 0) {
                const move = available[Math.floor(Math.random() * available.length)];
                executeLocalMove(move);
            }
        }

        function renderLocalBoard() {
            localBoard.forEach((val, i) => {
                const cell = $('lc' + i);
                cell.className = 'cell ' + (val === 'X' ? 'x' : (val === 'O' ? 'o' : ''));
                cell.innerText = val;
            });
        }

        function updateLocalUI() {
            $('lp1-badge').className = localTurn === 'X' ? 'p-tag active' : 'p-tag';
            $('lp2-badge').className = localTurn === 'O' ? 'p-tag active' : 'p-tag';
            $('local-status').innerText = localTurn === 'X' ? "X's Turn" : "O's Turn";
        }

        function checkWinLocal(b) {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for(let [x,y,z] of wins) {
                if(b[x] && b[x] === b[y] && b[x] === b[z]) return b[x];
            }
            if(!b.includes("")) return "Draw";
            return null;
        }

        function showLocalResult(winner) {
            show('modal-local-result');
            const title = $('lres-title');
            if (winner === 'Draw') {
                title.innerText = "It's a Draw!";
                title.style.color = "var(--gold)";
            } else {
                title.innerText = winner + " Wins!";
                title.style.color = "var(--primary)";
            }
        }
        function quitLocalGame() { showScreen('screen-home'); hide('modal-local-result'); }

        // ===== EXIT CONFIRM =====
        function confirmExit() { show('popup-exit-confirm'); }
        function executeExit() { hide('popup-exit-confirm'); leaveGame(); }

        // ===== MULTIPLAYER LOGIC =====
        function checkFeeAndCreate() {
            if (userCoins >= GAME_CONFIG.CREATE_ROOM_COST) {
                updateCoins(-GAME_CONFIG.CREATE_ROOM_COST);
                createRoom();
            } else {
                toast(`Need ${GAME_CONFIG.CREATE_ROOM_COST} Coins! Watch Ads.`);
            }
        }

        let myId = localStorage.getItem('uid') || 'u_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('uid', myId);
        
        let roomId = null;
        let isHost = false;
        let myMark = null;
        let roomRef = null;
        let timerInt = null;
        let serverOffset = 0;

        db.ref('.info/serverTimeOffset').on('value', snap => { serverOffset = snap.val(); });

        function createRoom() {
            roomId = Math.floor(100000 + Math.random() * 900000).toString();
            isHost = true;
            myMark = 'X';
            
            const roomData = {
                status: 'waiting',
                players: { p1: myId, p1Name: playerName || 'Player X' },
                board: Array(9).fill(""),
                turn: 'X',
                winner: null
            };

            roomRef = db.ref('rooms/' + roomId);
            roomRef.set(roomData).then(() => {
                $('disp-code').innerText = roomId;
                showScreen('screen-waiting');
                setupRoomListeners();
                roomRef.child('players/p1').onDisconnect().remove();
                roomRef.child('status').onDisconnect().set('paused');
            });
        }

        function joinRoom() {
            const code = $('join-code').value.trim();
            if(code.length !== 6) return toast("Invalid Code");

            roomId = code;
            isHost = false;
            myMark = 'O';
            roomRef = db.ref('rooms/' + roomId);

            roomRef.get().then(snap => {
                if(!snap.exists()) return toast("Room not found");
                const val = snap.val();

                if(val.players.p1 === myId || val.players.p2 === myId) {
                    if(val.players.p1 === myId) { isHost = true; myMark = 'X'; }
                    else { isHost = false; myMark = 'O'; }
                    setupRoomListeners();
                    roomRef.child(isHost ? 'players/p1Name' : 'players/p2Name').set(playerName || (isHost ? 'Player X' : 'Player O'));
                    roomRef.child(isHost ? 'players/p1' : 'players/p2').set(myId);
                    return;
                }

                if(val.players.p2) return toast("Room full");

                roomRef.child('players/p2Name').set(playerName || 'Player O');
                roomRef.child('players/p2').set(myId).then(() => {
                    roomRef.child('players/p2').onDisconnect().remove();
                    roomRef.child('status').onDisconnect().set('paused');
                    setupRoomListeners();
                });
            });
        }

        function setupRoomListeners() {
            $('game-room-id').innerText = "Room ID: " + roomId;
            
            roomRef.on('value', snap => {
                const data = snap.val();
                if(!data) { leaveGame(true); return; }

                if(isHost) {
                    if(data.status === 'waiting' && data.players.p2) {
                        roomRef.update({
                            status: 'countdown',
                            countdownStart: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                    if(data.status === 'paused' && data.players.p1 && data.players.p2) {
                        roomRef.update({
                            status: 'countdown',
                            countdownStart: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                }
                handleState(data);
                renderBoard(data);
            });
        }

        function handleState(data) {
            if(timerInt) clearInterval(timerInt);
            hide('paused-ui');

            switch(data.status) {
                case 'waiting':
                    if(!isHost) showScreen('screen-waiting');
                    hide('overlay-sync');
                    break;

                case 'countdown':
                    showScreen('screen-game');
                    show('overlay-sync');
                    hide('modal-result');
                    
                    const start = data.countdownStart;
                    timerInt = setInterval(() => {
                        const now = Date.now() + serverOffset;
                        const remaining = Math.ceil((5000 - (now - start)) / 1000);

                        if(remaining > 0) {
                            $('sync-timer').innerText = remaining;
                            $('sync-msg').innerText = "Match starting in...";
                        } else {
                            $('sync-timer').innerText = "GO!";
                            clearInterval(timerInt);
                            if(isHost) roomRef.child('status').set('playing');
                        }
                    }, 100);
                    break;

                case 'playing':
                    showScreen('screen-game');
                    hide('overlay-sync');
                    hide('modal-result');
                    break;

                case 'paused':
                    showScreen('screen-game');
                    show('overlay-sync');
                    $('sync-timer').innerText = "‚è∏";
                    $('sync-msg').innerText = "Opponent Disconnected";
                    show('paused-ui');
                    $('paused-room-code').innerText = roomId;
                    break;

                case 'finished':
                    showScreen('screen-game');
                    hide('overlay-sync');
                    showResult(data.winner);
                    break;
            }
        }

        function renderBoard(data) {
            const p1n = (data.players && data.players.p1Name) ? data.players.p1Name : 'Player X';
            const p2n = (data.players && data.players.p2Name) ? data.players.p2Name : 'Player O';
            
            const p1Badge = $('p1-badge');
            const p2Badge = $('p2-badge');
            
            p1Badge.innerText = `${p1n} (X)`;
            p2Badge.innerText = `${p2n} (O)`;
            
            p1Badge.className = (data.turn === 'X') ? 'p-tag active' : 'p-tag';
            p2Badge.className = (data.turn === 'O') ? 'p-tag active' : 'p-tag';
            
            $('status-text').innerText = (data.turn === myMark) ? "Your Turn" : "Opponent's Turn";

            data.board.forEach((val, i) => {
                const cell = $('c' + i);
                cell.className = 'cell ' + (val === 'X' ? 'x' : (val === 'O' ? 'o' : ''));
                cell.innerText = val;
            });
        }

        function move(idx) {
            roomRef.get().then(snap => {
                const data = snap.val();
                if(data.status !== 'playing') return;
                if(data.turn !== myMark) return;
                if(data.board[idx] !== "") return;

                const nextTurn = myMark === 'X' ? 'O' : 'X';
                let updates = {};
                updates['board/' + idx] = myMark;
                updates['turn'] = nextTurn;

                const b = [...data.board];
                b[idx] = myMark;
                const winner = checkWinLocal(b); 
                
                if(winner) {
                    updates['status'] = 'finished';
                    updates['winner'] = winner;
                }
                roomRef.update(updates);
            });
        }

        function showResult(winner) {
            show('modal-result');
            const title = $('res-title');
            const msg = $('res-msg');
            
            if(winner === 'Draw') {
                title.innerText = "DRAW";
                title.style.color = "var(--gold)";
                msg.innerText = "It was a tie!";
            } else if(winner === myMark) {
                title.innerText = "VICTORY!";
                title.style.color = "var(--primary)";
                msg.innerText = "You won!";
                updateStats(true);
            } else {
                title.innerText = "DEFEAT";
                title.style.color = "var(--accent)";
                msg.innerText = "Better luck next time.";
                updateStats(false);
            }

            if(isHost) show('btn-restart');
            else hide('btn-restart');
        }

        function restartGame() {
            if(!isHost) return;
            roomRef.update({
                status: 'countdown',
                countdownStart: firebase.database.ServerValue.TIMESTAMP,
                board: Array(9).fill(""),
                winner: null,
                turn: 'X'
            });
        }

        function leaveGame(remote = false) {
            if(roomId && roomRef) {
                roomRef.off();
                if(!remote) {
                    roomRef.child(isHost ? 'players/p1' : 'players/p2').remove();
                    roomRef.child('status').set('paused');
                }
            }
            roomId = null;
            if(timerInt) clearInterval(timerInt);
            showScreen('screen-home');
            hide('modal-result');
            hide('overlay-sync');
            if(remote) toast("Connection lost");
        }
    </script>
</body>
</html>
